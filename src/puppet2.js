const fs = require('fs');
const puppeteer = require('puppeteer');

const divider = "*******************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************";

function extractItems(items) {
  //const extractedParentElements = document.getElementsByClassName('css-901oao r-hkyrab r-1qd0xha r-a023e6 r-16dba41 r-ad9z0x r-bcqeeo r-bnwqim r-qvutc0');
  //const extractedParentElements = document.getElementsByClassName('css-901oao r-jwli3a r-1qd0xha r-a023e6 r-16dba41 r-ad9z0x r-bcqeeo r-bnwqim r-qvutc0');
  // tw menja nazive klasa, ovde konkretno druga klasa je drugacija, pa je treba izbaciti iz pretrage:
  // const extractedParentElements = document.getElementsByClassName('css-901oao r-1qd0xha r-a023e6 r-16dba41 r-ad9z0x r-bcqeeo r-bnwqim r-qvutc0');                               
  // prethodni red vazi ukoliko je prvo bio potreban login!!! a uko idemo bez logina onda su klase ovakve:
  const extractedParentElements = document.getElementsByClassName('TweetTextSize TweetTextSize--normal js-tweet-text tweet-text');
  //const tweetTexts = [];
  for (let parentElement of extractedParentElements) {
    // items.push(parentElement.firstElementChild.innerText); // ovo vazi za slucaj da je bio izvrsen login
    items.push(parentElement.innerText); // ovo vazi za slucaj bez prethodnog logovanja
  }
  console.log(items);
  console.log("*********************************************");
  return items;
}

async function scrTweets(page, extractItems) {
  let items = [];
  try {
    //let previousHeight;
    //while (items.length < itemTargetCount) {
      for (let i = 0; i < 3; i++) {
        items = await page.evaluate(extractItems, items);
        //items.push(oneCycleItems);
        await page.evaluate('window.scrollTo(0, document.body.scrollHeight)');
        console.log(i+1 + '. skrol izvrsen');
        await page.waitFor(3000);
      }
  } catch(e) {
    console.log(e);
  }
  return items;
}

(async () => {
  try {
    const browser = await puppeteer.launch({
      headless: false,
      //args: ['--no-sandbox', '--disable-setuid-sandbox'],
    });

    const page = await browser.newPage();

    page.setViewport({ width: 800, height: 800 });
    // open twitter


    
    /* skloniti samo ovaj pocetni i zavrsni znak kojim je zakomentarisana cela Login sekcija ukoliko je potrebno prethodno izvrsiti login
    // ***************  Login   ********
    await page.goto('https://twitter.com/login');

    
    // await page.$eval('#page-container > div > div.signin-wrapper > form > fieldset > div:nth-child(2) > input', e => {  // selektor se moze i ovako pisati, tako daje chrome na copy selector
    // ali mozda je pouzdanije stavljati samo nazive svih klasa jednu za drugom BEZ RAZMAKA samo sa tackom ispred svake
    await page.$eval('.js-username-field.email-input.js-initial-focus', e => {
      // ne ispisuje se u konzolu shell-a, vec u konzoli chromiuma dok je na stranici https://twitter.com/login (treba zakomentarisati page.click da bi se videlo)
      console.log(typeof e); // Object
      console.log(e.nodeName); // INPUT
      console.log(e); // <input class="js-username-field email-input js-initial-focus" type="text" name="session[username_or_email]" autocomplete="on" value="" placeholder="Phone, email or username"></input>
      // return e.value = "dragor67361551"}); 
      return e.value = "looplessa"
    });
    //await page.$eval('.js-password-field', e => e.value = "snjufk1l128");
    await page.$eval('.js-password-field', e => e.value = "novasifra");

    // await Promise.all([
    //   page.waitForNavigation(), // The promise resolves after navigation has finished
    //   await page.click('.submit.EdgeButton.EdgeButton--primary.EdgeButtom--medium'), // Clicking the link will indirectly cause a navigation
    // ]);

    await page.click('.submit.EdgeButton.EdgeButton--primary.EdgeButtom--medium')

    // wait till page load
    //await page.waitForNavigation();

    // ******** kraj Login-a *********
    */


    await page.goto('https://twitter.com/nitropolit');

    //await page.waitForSelector('.css-1dbjc4n.r-19i43ro'); // ovo ne vredi jer se menjaju imena klasa
    await page.waitFor(2000); // tako da sam stavio proizvoljno da saceka 2sec da se ucita stranica

    const items = await scrTweets(page, extractItems);
    const uniqueItems = [...new Set(items)]
    
    /*
    const body0 = await page.evaluate(() => {
      return document.querySelector('body').innerHTML;
    });

    console.log(body0);
    console.log(divider);    

    await page.waitForSelector('#react-root > div > div > div > main > div > div.css-1dbjc4n.r-aqfbo4.r-1niwhzg.r-16y2uox > div > div > div > div > div:nth-child(2) > div > div > div:nth-child(3) > section > div > div > div > div:nth-child(6) > div > div > article');
    const body = await page.evaluate(() => {
      return document.querySelector('body').innerHTML;
    });*/


    // const sadrzaj = await page.evaluate(() => {
    //   return document.querySelector('#react-root > div > div > div > main > div > div.css-1dbjc4n.r-aqfbo4.r-1niwhzg.r-16y2uox > div > div > div > div > div:nth-child(2) > div > div > div:nth-child(3) > section > div > div > div').innerHTML;
    // });
    //console.log(body);
    // console.log(sadrzaj);
    console.log("ALL TWEETS: ****************************************");
    console.log(items);
    console.log("UNIQUE TWEETS: ****************************************");
    console.log(uniqueItems);
    fs.writeFileSync('./uniqueItems2.txt', uniqueItems.join('\n') + '\n');
  } catch (error) {
    console.log(error);
  }
})();


// selektor za statuse:
// document.getElementsByClassName('css-901oao r-hkyrab r-1qd0xha r-a023e6 r-16dba41 r-ad9z0x r-bcqeeo r-bnwqim r-qvutc0')[8].firstElementChild.innerText